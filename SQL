WITH Date_Range AS (
    SELECT 
        CAST('2023-01-01' AS DATE) AS Week_Start,  -- Replace with the required start date
        DATEADD(DAY, 6, CAST('2023-01-01' AS DATE)) AS Week_End
    UNION ALL
    SELECT 
        DATEADD(DAY, 7, Week_Start),
        DATEADD(DAY, 13, Week_Start)
    FROM Date_Range
    WHERE DATEADD(DAY, 7, Week_Start) <= GETDATE()
),

Filtered_Employees AS (
    SELECT *
    FROM Employees
    WHERE Level_4_Manager = 'ABC'
),

Active_Employees AS (
    SELECT 
        DR.Week_Start,
        COUNT(DISTINCT FE.EMPLID) AS Active_Count
    FROM Date_Range DR
    LEFT JOIN Filtered_Employees FE
        ON FE.ROW_EFF_TS <= DR.Week_End 
        AND FE.ROW_EXP_TS >= DR.Week_Start
    GROUP BY DR.Week_Start
),

Joined_Employees AS (
    SELECT 
        DR.Week_Start,
        COUNT(DISTINCT FE.EMPLID) AS Joined_Count
    FROM Date_Range DR
    LEFT JOIN Filtered_Employees FE
        ON FE.ROW_EFF_TS BETWEEN DR.Week_Start AND DR.Week_End
    GROUP BY DR.Week_Start
),

Left_Employees AS (
    SELECT 
        DR.Week_Start,
        COUNT(DISTINCT FE.EMPLID) AS Left_Count,
        SUM(CASE 
            WHEN FE.EMPL_Status = 'T' AND FE.ROW_EXP_TS BETWEEN DR.Week_Start AND DR.Week_End THEN 1 ELSE 0 
        END) AS Company_Left,
        SUM(CASE 
            WHEN FE.ROW_EXP_TS BETWEEN DR.Week_Start AND DR.Week_End 
                 AND EXISTS (
                    SELECT 1 
                    FROM Filtered_Employees FE_Next
                    WHERE FE_Next.EMPLID = FE.EMPLID
                    AND FE_Next.ROW_EFF_TS = FE.ROW_EXP_TS + 1
                    AND FE_Next.AU <> FE.AU
                 )
            THEN 1 ELSE 0 
        END) AS Team_Left,
        SUM(CASE 
            WHEN FE.ROW_EXP_TS BETWEEN DR.Week_Start AND DR.Week_End 
                 AND EXISTS (
                    SELECT 1 
                    FROM Filtered_Employees FE_Next
                    WHERE FE_Next.EMPLID = FE.EMPLID
                    AND FE_Next.ROW_EFF_TS = FE.ROW_EXP_TS + 1
                    AND FE_Next.RPTS_TO_MGR_NAME <> FE.RPTS_TO_MGR_NAME
                 )
            THEN 1 ELSE 0 
        END) AS Manager_Change
    FROM Date_Range DR
    LEFT JOIN Filtered_Employees FE
        ON FE.ROW_EXP_TS BETWEEN DR.Week_Start AND DR.Week_End
    GROUP BY DR.Week_Start
),

Employee_Details AS (
    SELECT 
        FE.EMPLID,
        FE.Name,
        FE.AU,
        FE.RPTS_TO_MGR_NAME,
        FE.EMPL_Status,
        FE.ROW_EFF_TS,
        FE.ROW_EXP_TS,
        CASE 
            WHEN FE.ROW_EFF_TS BETWEEN DR.Week_Start AND DR.Week_End THEN 'Joined'
            WHEN FE.ROW_EXP_TS BETWEEN DR.Week_Start AND DR.Week_End THEN 
                CASE 
                    WHEN FE.EMPL_Status = 'T' THEN 'Left Company'
                    WHEN EXISTS (
                        SELECT 1 
                        FROM Filtered_Employees FE_Next
                        WHERE FE_Next.EMPLID = FE.EMPLID
                        AND FE_Next.ROW_EFF_TS = FE.ROW_EXP_TS + 1
                        AND FE_Next.AU <> FE.AU
                    ) THEN 'Left Team'
                    WHEN EXISTS (
                        SELECT 1 
                        FROM Filtered_Employees FE_Next
                        WHERE FE_Next.EMPLID = FE.EMPLID
                        AND FE_Next.ROW_EFF_TS = FE.ROW_EXP_TS + 1
                        AND FE_Next.RPTS_TO_MGR_NAME <> FE.RPTS_TO_MGR_NAME
                    ) THEN 'Manager Changed'
                    ELSE 'Other'
                END
            ELSE 'Active'
        END AS Employee_Event,
        DR.Week_Start
    FROM Filtered_Employees FE
    CROSS JOIN Date_Range DR
    WHERE (FE.ROW_EFF_TS BETWEEN DR.Week_Start AND DR.Week_End
           OR FE.ROW_EXP_TS BETWEEN DR.Week_Start AND DR.Week_End)
)

SELECT 
    AR.Week_Start,
    AR.Active_Count,
    JR.Joined_Count,
    LR.Left_Count,
    LR.Company_Left,
    LR.Team_Left,
    LR.Manager_Change
FROM Active_Employees AR
LEFT JOIN Joined_Employees JR ON AR.Week_Start = JR.Week_Start
LEFT JOIN Left_Employees LR ON AR.Week_Start = LR.Week_Start

UNION ALL

SELECT 
    ED.Week_Start,
    NULL AS Active_Count,
    NULL AS Joined_Count,
    NULL AS Left_Count,
    NULL AS Company_Left,
    NULL AS Team_Left,
    NULL AS Manager_Change
FROM Employee_Details ED
ORDER BY Week_Start;